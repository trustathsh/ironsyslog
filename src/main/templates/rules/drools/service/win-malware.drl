import function de.hshannover.f4.trust.ironsyslog.util.DroolsRuleLogger.debug
import de.hshannover.f4.trust.ironsyslog.ep.events.IronSyslogServerEvent
import de.hshannover.f4.trust.ironsyslog.ep.events.MalwareDetectedEvent
import java.util.regex.Matcher
import java.util.regex.Pattern
import de.hshannover.f4.trust.ifmapj.metadata.EventType

declare IronSyslogServerEvent
@role(event)
@timestamp(timestamp)
end

declare MalwareDetectedEvent
@role(event)
@timestamp(timestamp)
end

rule "wineventlog malware detected german"
when
	$ise:IronSyslogServerEvent(message.startsWith("Microsoft_Antimalware: 1116: Von Microsoft-Antischadsoftware wurde Schadsoftware oder andere potenziell unerwünschte Software entdeckt."))
then
	debug("Rule \"" + drools.getRule().getName() + "\" fired.");
	String message = $ise.getMessage();
	Pattern p = Pattern.compile("Microsoft_Antimalware: 1116: Von Microsoft-Antischadsoftware wurde Schadsoftware oder andere potenziell unerwünschte Software entdeckt. Weitere Informationen finden Sie hier: .* Name: (.*) ID: .* Benutzer: (.*) Prozessname: .*");
	Matcher m = p.matcher(message);
	if (m.find()) {
		String date = $ise.getTimestamp().toString();
		String name = m.group(1);
		String id = "Microsoft Security Essentials at " + m.group(2);
		String host = $ise.getHost();
		EventType type = EventType.other;
		int magnitude = 50;
		int confidence = 100;
		int significance = 1;
		insert ( new MalwareDetectedEvent(name, type, date, id, magnitude, confidence, significance, message, null, host) );
	}
end
